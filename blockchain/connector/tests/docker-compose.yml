name: kms-connector-test

services:
  kms-full-node:
    build:
      context: ../../../
      dockerfile: ./blockchain/contracts/operations/docker/ci.dockerfile
    ports:
      - "36656:26656"
      - "36658:26657"
      - "1317:1317"
      - "9090:9090"
    volumes:
      - ../../scripts/:/app/scripts
      - validator_secrets:/app/secrets
    entrypoint: [ "/app/scripts/bootstrap_validator.sh" ]
    healthcheck:
      test: "wget -Sq --spider http://localhost:26657/status"
      interval: 1s
      timeout: 1s
      retries: 5
      start_period: 10s

  # Smart contract deployment
  dev-kms-blockchain-asc-deploy:
    image: ghcr.io/zama-ai/kms-blockchain-asc:latest
    depends_on:
      kms-full-node:
        condition: service_healthy
    environment:
      VALIDATOR_NODE_ENDPOINT: http://kms-full-node:26657
      MODE: centralized
    build:
      context: ../../../
      dockerfile: ./blockchain/contracts/operations/docker/ci.dockerfile
    volumes:
      - ../../scripts/:/app/scripts
      - validator_secrets:/app/secrets
    entrypoint: >
      /bin/sh -c "
      chmod +x /app/scripts/setup_wallets.sh &&
      chmod +x /app/scripts/deploy_contracts.sh &&
      /app/scripts/setup_wallets.sh &&
      /app/scripts/deploy_contracts.sh
      "

volumes:
  validator_secrets:
