name: Docker Build and Push

on:
  workflow_call:
    inputs:
      push_image:
        type: boolean
        default: true
        required: false
    outputs:
      image_name:
        description: "Image Name with Tag generated by this task"
        value: "${{ jobs.build-and-push-docker.outputs.image_name }}"
      image_tag:
        description: "Image Tag generated by this task"
        value: "${{ jobs.build-and-push-docker.outputs.image_tag }}"

jobs:
  build-and-push-docker:
    runs-on: ubuntu-latest
    outputs:
      image_name: ${{ steps.final_image.outputs.image }}
      image_tag: ${{ steps.final_version.outputs.tag }}
    steps:
      - name: Checkout Project
        uses: actions/checkout@v4
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Current branch sha
        if: github.event_name != 'release'
        run: |
          echo "DOCKER_TAG_IMAGE=$(git rev-parse --short "$GITHUB_SHA")" >> $GITHUB_ENV
      - name: Current Tag
        if: github.event_name == 'release'
        run: |
          echo "DOCKER_TAG_IMAGE=${{  github.ref_name }}" >> $GITHUB_ENV

      - name: Docker Build and Push
        uses: docker/build-push-action@v5
        with:
          file: operations/docker/ci.dockerfile
          push: ${{ inputs.push_image }}
          tags: ghcr.io/zama-ai/ddec:${{env.DOCKER_TAG_IMAGE}},ghcr.io/zama-ai/ddec:latest
      - name: Write Image to outputs
        id: final_image
        run: echo "image=ghcr.io/zama-ai/ddec:${{env.DOCKER_TAG_IMAGE}}" >> "$GITHUB_OUTPUT"
      - name: Write Tag to outputs
        id: final_version
        run: echo "tag=${{env.DOCKER_TAG_IMAGE}}" >> "$GITHUB_OUTPUT"




